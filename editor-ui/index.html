<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">

    <title>Getting started with Metadata Editor</title>
    <!--External dependencies-->
    <script src="https://cdn.jsdelivr.net/npm/@kit-data-manager/metadata-editor/deps/jquery/jquery.min.js"></script>
    <link rel="stylesheet"
          href="https://cdn.jsdelivr.net/npm/@kit-data-manager/metadata-editor/deps/opt/bootstrap/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@kit-data-manager/metadata-editor@0.9.3/deps/opt/fontawesome/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@kit-data-manager/metadata-editor/deps/opt/bootstrap/js/bootstrap.min.js"></script>
    <link rel="stylesheet"
          href="https://cdn.jsdelivr.net/npm/@kit-data-manager/metadata-editor/deps/opt/fontawesome/css/all.min.css"/>
    <script src="https://cdn.jsdelivr.net/npm/@kit-data-manager/metadata-editor/deps/opt/validator/ajv/ajv.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@kit-data-manager/metadata-editor/deps/underscore/underscore-umd-min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@kit-data-manager/metadata-editor@0.9.3/deps/opt/code-editor/ace/ace.min.js"></script>
    
    
    <!--Metadata Editor library-->
    <script src="./js/popper.js"></script>
    <!--script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@kit-data-manager/metadata-editor/deps/jsonform/jsonform.min.js"></script-->
    <script type="text/javascript" src="./js/jsonform.js"></script>
    <!--script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@kit-data-manager/metadata-editor/lib/js/metadataeditor.js"></script-->
    <script type="text/javascript" src="./js/metadataeditor.js"></script>
    <script type="text/javascript" src="./js/FileSaver.min.js"></script>
    <!--Input data-->
    <script type="text/javascript" src="./test_schema.js"></script>
    <script type="text/javascript" src="./test_ui_schema.js"></script>

    <!--Basic stylesheet-->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@kit-data-manager/metadata-editor/deps/opt/bootstrap/css/bootstrap-theme.min.css"/>

    <!--link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@kit-data-manager/metadata-editor/lib/css/metadataeditor.style.basic.css" /-->
    <link rel="stylesheet" href="./css/styles.css">
</head>

<body>


<div class="container">
    <div class="col-12">
        <div class="boxlist margin-top-30" id="training-box">
            <div class="box-header bg-green-blue">
                <h3 class="box-title">Metadata Editor</h3>
            </div>
            <div class="row g-3">
                <div class="col-sm-2">
                    <button id="loadFileXml" onclick="document.getElementById('jsonfileinput').click();"><i class="fa-solid fa-upload"></i></button>
                    <input type="file" style="display:none;" id="jsonfileinput" name="file"/>
                </div>
                <div class="col-sm-2">
                    <button id="reset" class="form-control-sg"><i class="fa-solid fa-trash-can"></i></button>
                </div>
                <div class="col-sm-2">
                    <div class="form-check form-control-sg checkbox">
                        <input class="form-check-input form-control-sg" type="checkbox" id="validateCheck">
                        <label class="form-check-label form-control-sg" for="validateCheck">Validation</label>
                    </div>
                </div>
            </div>
            <hr/>
            <div class="box-body">
                <form id="plain"></form>
            </div>
        </div>
    </div>
</div>

<script src="/Users/bl1752/Desktop/KIT/MetadataEditor/TermWithURI/editor-ui/node_modules/rdflib/dist/rdflib.min.js"></script>
<script>


    
    const urlSearchParams = new URLSearchParams(window.location.search);
    const params = Object.fromEntries(urlSearchParams.entries());
    const cb = document.querySelector('#validateCheck')
    const doValidate = (params.validate == "true");
    if(doValidate){
        cb.checked = true;
    }else{
        cb.checked = false;
            }

    
    let termsToResolve = [
                {

            "termId":"userName",
            'termDataUri': dataModel.$defs.userName.properties.userNameValues.termURI ,
            "replacementFunction": (userName, termTitle, termDescription) => {
                                    dataModel.$defs.userName.properties.userNameValues.title   = termTitle;
                                    dataModel.$defs.userName.properties.userNameValues.description = termDescription

                                    }
            },

            {
            "termId":"userRole",
            'termDataUri': dataModel.$defs.userRole.properties.userRoleValues.termURI,
            "termUriNarrower":"yes",
            "replacementFunction": (userRolesList, termTitle, termDescription) => {
                                    dataModel.$defs.userRole.properties.userRoleValues.enum   = userRolesList;
                                    dataModel.$defs.userRole.properties.userRoleValues.title   = termTitle;
                                    dataModel.$defs.userRole.properties.userRoleValues.description = termDescription
                                    }
            }
            
        ]
   

    async function getTermsList (termsToResolveObj) {
        

        for (let i=0;i<termsToResolveObj.length;i++){


            var jsonValues = []  //saves links for creating and downloading json schema
            var dataModelValues = [] //saves narrower terms list

            termInfos = await fetchDataFromURI(termsToResolveObj[i]["termDataUri"])

            if ("graph" in termInfos){

                termDataGraph = termInfos.graph
                //console.log("Key", termInfos.graph)
                
                for (var j = 0; j < termDataGraph.length; j++){

                    if (termsToResolveObj[i]["termTitle"] === termDataGraph[j]["prefLabel"]){

                        termWithNarrowerTerms = termDataGraph[j]
                        console.log("mainTerm",termDataGraph[j]);

                        narrowerTerms = termWithNarrowerTerms.narrower
                        console.log("Narrower terms", narrowerTerms)

                        for (var k = 0; k < narrowerTerms.length; k++) {

                            const termObject = termDataGraph.find(item => item.uri === narrowerTerms[k].uri);
                            console.log("TermTerm1",termObject.prefLabel )
                            console.log("Nar Term Uri", narrowerTerms[k].uri)
                            narTermPrefLabel = termObject.prefLabel 
                            narTermUri = termObject.uri 

                            newObject = {"uri" : narTermUri, "prefLabel":narTermPrefLabel}
                            dataModelValues.push(narTermPrefLabel)
                            jsonValues.push(newObject)
                        }

                        

                    }  
                    }
                termsToResolveObj[i]["jsonValues"] = jsonValues  //links for creating and downloading json schema
                termsToResolveObj[i]["dataModelValues"] = dataModelValues  //narrower terms values
                console.log("Data Model Values", dataModelValues)
                console.log("json Values", jsonValues)

                
            }

        }
        
    }

   

    //function which gets the term's prefLable and description
    const getTermsTitleDescr = (termInfos, termsToResolveObj) =>{

        //results from fetch for pref terms with narrower terms are different, because of this it is procced seperatly
        if (termsToResolveObj["termId"] == "userRole") {

            const userRole = termInfos.graph.find(item => item.prefLabel === "User Role");
            const prefLabel = userRole.prefLabel;
            termsToResolveObj["termTitle"] = prefLabel
            const definition = userRole["skos:definition"].value;    
            termsToResolveObj["termDescription"]  = definition
           
    
        }
        else {
        
            var term_title = termInfos.prefLabel
            termsToResolveObj["termTitle"] = term_title

            definition = termInfos["skos:definition"].value
            termsToResolveObj["termDescription"] = definition
        }

       
            

    }

    //reads URIs
    function fetchDataFromURI(uri) {
        return new Promise((resolve, reject) => {
            // Perform async operation to fetch data from the given URI
            // and resolve the promise with the fetched data
            // or reject the promise with an error if something goes wrong
            
            // Example of using Fetch API:
            fetch(uri)
            .then(response => response.json())
            .then(data => resolve(data))
        });
        }


    //reads URIs of the terms and defines new values for dataModel
    //the list termsToResolve has parameters of each term and hier will be defined another needed parameters like:prefLable, description, narrower terms and links for generating json metadata document
    async function getValues (termsToResolve) {

        
       
        for (let i=0;i<termsToResolve.length;i++){
            
            termInfos = await fetchDataFromURI(termsToResolve[i]["termDataUri"]) //consists prefLabel and description of the term
            await getTermsTitleDescr(termInfos,  termsToResolve[i])  //defines prefLabel and description in the termsToResolve object
            await getTermsList(termsToResolve)  //
            
            termsToResolve[i].replacementFunction(termsToResolve[i]["dataModelValues"], termsToResolve[i]["termTitle"],termsToResolve[i]["termDescription"] )

        }

        
        return termsToResolve
    }
    

    //first we call the function getValues and read term values from the vocabuöary, add values to the dataModel and than do another metadata editor actions
    getValues(termsToResolve)
        .then(dataObj => {
            
            console.log('TERMS INFO', termsToResolve)
            

            resolveRefs(dataModel, dataModel.$defs);

            var options = {     
                operation: "CREATE",
                buttonTitle: "Download",
                uiForm: this.uiSchema,
                dataModel: this.dataModel,
                validate: doValidate
            };

            

            var data = localStorage.getItem("sem_resource");
            var resource = undefined;
            if(data){
                options.operation = "UPDATE";
                resource = JSON.parse(data);
                options.resource = this.resource;
            }

            document.getElementById("validateCheck").addEventListener("click", function() {
                const cb = document.querySelector('#validateCheck')
                window.location.href = window.location.pathname+"?validate=" + cb.checked;
            });

            document.getElementById("reset").addEventListener("click", function() {
                localStorage.removeItem('sem_resource');
                window.location.reload();
            });

            document.getElementById("jsonfileinput").addEventListener("change", function() {
                var file_to_read = document.getElementById("jsonfileinput").files[0];
                var fileread = new FileReader();
                fileread.onload = function(e) {
                    var content = e.target.result;
                    var intern = JSON.parse(content); // parse json
                    localStorage.setItem('sem_resource', JSON.stringify(intern));
                    window.location.reload();
                };
                fileread.readAsText(file_to_read);
            });

            $('body').initializeModals();


            $('#plain').metadataeditorForm(options, (value) => {
               
                var value_new = JSON.parse(value)

                //takes keys of the Value: User Name, User Role etc.
                keys = Object.keys(value_new)  

                //for each keys repplaces Value with the URI: solid - http://.../solid
                keys.forEach((key, index) => {
                    
                    //finds in termsToResolve Obj with this key, and takes JsonValues Arr, where there is uri of the Value
                    for (let i=0;i<termsToResolve.length;i++){


                        if (key === termsToResolve[i].termId && termsToResolve[i].termUriNarrower) {

                            
                            //in the value_new each Field Values are separate obj
                            fieldData = value_new[key]
                            keys_data =  Object.keys(fieldData)
            
                            keys_data.forEach((key, index) => {

                                const jsonValuesData = termsToResolve[i].jsonValues.find(terms => terms.prefLabel === fieldData[key] );
                                fieldData[key]  = jsonValuesData.uri
                            })


                        }
                    }

                })

                const valueWithUri = JSON.stringify(value_new)

                var fileName = 'sem_metadata.json';

                // Create a blob of the data
                var fileToSave = new Blob([valueWithUri], {
                    type: 'application/json'
                });

                // Save the file
                saveAs(fileToSave, fileName);
            });

                    })
                    
        
    
</script>


</body>
</html>
